#!/usr/bin/env bash
set -euo pipefail

# GitHub CLI extension to add Enterprise Team members to Cost Centers
# Author: GitHub Copilot
# Version: 1.0.0

# Configurable default headers
API_VERSION="2022-11-28"
COMMON_HEADERS=(-H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: ${API_VERSION}")

usage() {
  cat <<EOF
Usage:
  gh cost-center add-team -e <enterprise> -t <team> -c <cost-center> [OPTIONS]

Description:
  Add members of an Enterprise Team to a Cost Center. This command will:
  1. Find the specified enterprise team by name
  2. Get all members of that team  
  3. Find the specified cost center by name (or create it if it doesn't exist)
  4. Optionally remove users from cost center who are not in the team (--sync)
  5. Add the team members to the cost center

Flags:
  -e, --enterprise         Enterprise slug (required)
  -t, --team               Enterprise team name or slug (required)
  -c, --cost-center        Cost center name (required)
      --cost-center-id     Cost center ID (overrides --cost-center)
      --create-cost-center Automatically create cost center if it doesn't exist
      --sync               Remove users from cost center who are not in the team
      --force              Force mode: auto-create cost centers and skip all confirmations
      --dry-run            Show actions without applying changes
  -y, --yes                Skip confirmation prompts
      --verbose            Extra logging output
  -h, --help               Show this help message

Examples:
  gh cost-center add-team -e myenterprise -t "Engineering Team" -c "Engineering Cost Center"
  gh cost-center add-team -e myenterprise -t engineering-team -c "Engineering Cost Center" --dry-run
  gh cost-center add-team -e myenterprise -t engineering-team --cost-center-id abc123 -y
  gh cost-center add-team -e myenterprise -t "New Team" -c "New Cost Center" --create-cost-center
  gh cost-center add-team -e myenterprise -t "Data Team" -c "Analytics Budget" --force --verbose
  gh cost-center add-team -e myenterprise -t "DevOps Team" -c "Infrastructure Budget" --sync

Requirements:
  - GitHub Enterprise Cloud with Enterprise Teams and Cost Centers enabled
  - Enterprise admin permissions
  - Personal access token with manage_billing:enterprise scope

EOF
}

log() { echo "[$(date +%H:%M:%S)] $*" >&2; }
vlog() { [[ -n "${VERBOSE:-}" ]] && log "$@"; }
die() { echo "Error: $*" >&2; exit 1; }

confirm() {
  [[ -n "${YES:-}" ]] && return 0
  read -r -p "$1 [y/N]: " ans
  [[ "$ans" == "y" || "$ans" == "Y" ]]
}

# Portable function to read lines into array (alternative to mapfile)
read_lines_to_array() {
  local array_name="$1"
  local -a temp_array=()
  local line
  
  while IFS= read -r line; do
    [[ -n "$line" ]] && temp_array+=("$line")
  done
  
  # Use eval to assign to the named array
  eval "${array_name}=(\"\${temp_array[@]}\")"
}

# Alternative approach using while loop for better compatibility
populate_array_from_command() {
  local array_name="$1"
  local command="$2"
  local -a temp_array=()
  local line
  
  while IFS= read -r line; do
    [[ -n "$line" ]] && temp_array+=("$line")
  done < <(eval "$command")
  
  # Use eval to assign to the named array, handle empty arrays
  if [[ ${#temp_array[@]} -gt 0 ]]; then
    eval "${array_name}=(\"\${temp_array[@]}\")"
  else
    eval "${array_name}=()"
  fi
}

# Function to create a new cost center
create_cost_center() {
  local enterprise="$1"
  local cost_center_name="$2"
  
  vlog "Creating cost center '$cost_center_name'..."
  
  local payload
  payload=$(jq -nc --arg name "$cost_center_name" '{name: $name}')
  
  local response
  if response=$(gh api "${COMMON_HEADERS[@]}" \
    --method POST \
    "/enterprises/${enterprise}/settings/billing/cost-centers" \
    --input - <<<"$payload" 2>/dev/null); then
    
    # Extract the ID from the response
    local new_id
    new_id=$(echo "$response" | jq -r '.id // empty')
    
    if [[ -n "$new_id" && "$new_id" != "null" ]]; then
      echo "$new_id"
      return 0
    else
      return 1
    fi
  else
    return 1
  fi
}

# Function to remove users from a cost center
remove_users_from_cost_center() {
  local enterprise="$1"
  local cost_center_id="$2"
  shift 2
  local users_to_remove=("$@")
  
  if [[ ${#users_to_remove[@]} -eq 0 ]]; then
    return 0
  fi
  
  vlog "Removing ${#users_to_remove[@]} users from cost center..."
  
  # The API accepts up to 50 resources per request
  local batch_size=50
  local removed=0
  local failures=0
  
  for ((i=0; i<${#users_to_remove[@]}; i+=batch_size)); do
    # Get batch of users
    local batch=("${users_to_remove[@]:i:batch_size}")
    local current_batch_size=${#batch[@]}
    
    vlog "Removing batch of $current_batch_size users: ${batch[*]}"
    
    # Create JSON payload for this batch
    local payload
    payload=$(printf '%s\n' "${batch[@]}" | jq -R . | jq -s '{users: .}')
    
    if gh api "${COMMON_HEADERS[@]}" \
      --method DELETE \
      "/enterprises/${enterprise}/settings/billing/cost-centers/${cost_center_id}/resource" \
      --input - <<<"$payload" >/dev/null 2>&1; then
      removed=$((removed + current_batch_size))
      vlog "Successfully removed batch of $current_batch_size users"
    else
      failures=$((failures + current_batch_size))
      echo "Failed to remove batch: ${batch[*]}" >&2
    fi
  done
  
  if [[ $removed -gt 0 ]]; then
    echo "✓ Removed $removed users from cost center"
  fi
  
  if [[ $failures -gt 0 ]]; then
    echo "✗ Failed to remove $failures users" >&2
    return 1
  fi
  
  return 0
}

# Parse arguments
ENTERPRISE=""
TEAM_INPUT=""
CC_NAME=""
CC_ID=""
DRY_RUN=""
YES=""
VERBOSE=""
CREATE_CC=""
FORCE=""
SYNC=""

cmd_add_team() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -e|--enterprise) ENTERPRISE="$2"; shift 2;;
      -t|--team) TEAM_INPUT="$2"; shift 2;;
      -c|--cost-center) CC_NAME="$2"; shift 2;;
      --cost-center-id) CC_ID="$2"; shift 2;;
      --create-cost-center) CREATE_CC="1"; shift;;
      --sync) SYNC="1"; shift;;
      --dry-run) DRY_RUN="1"; shift;;
      -y|--yes) YES="1"; shift;;
      --force) FORCE="1"; YES="1"; CREATE_CC="1"; shift;;
      --verbose) VERBOSE="1"; shift;;
      -h|--help) usage; exit 0;;
      *) die "Unknown flag: $1";;
    esac
  done

  # Validate required arguments
  [[ -z "$ENTERPRISE" ]] && die "Enterprise slug is required (-e/--enterprise)"
  [[ -z "$TEAM_INPUT" ]] && die "Team name is required (-t/--team)"
  [[ -z "$CC_NAME" && -z "$CC_ID" ]] && die "Cost center name (-c/--cost-center) or ID (--cost-center-id) is required"

  # Check if gh is authenticated
  if ! gh auth status >/dev/null 2>&1; then
    die "Not authenticated with GitHub. Run 'gh auth login' first."
  fi

  if [[ -n "$FORCE" ]]; then
    log "Starting in FORCE mode - will auto-create cost centers and skip confirmations..."
  else
    log "Starting to add enterprise team '$TEAM_INPUT' members to cost center..."
  fi

  # Step 1: Resolve cost center ID if only name provided
  if [[ -z "$CC_ID" ]]; then
    vlog "Fetching cost centers for enterprise '$ENTERPRISE'..."
    
    COST_CENTERS_JSON=$(gh api "${COMMON_HEADERS[@]}" \
      "/enterprises/${ENTERPRISE}/settings/billing/cost-centers" \
      --paginate 2>/dev/null || die "Failed to fetch cost centers. Check enterprise permissions and name.")
    
    # Parse the costCenters array from the response
    CC_ID=$(echo "$COST_CENTERS_JSON" | jq -r --arg name "$CC_NAME" '.costCenters[]? | select(.name==$name) | .id' | head -n1)
    
    if [[ -z "$CC_ID" || "$CC_ID" == "null" ]]; then
      if [[ -n "$CREATE_CC" ]]; then
        # Cost center not found, but we're allowed to create it
        echo ""
        echo "Cost center '$CC_NAME' not found in enterprise '$ENTERPRISE'."
        
        if [[ -n "$DRY_RUN" ]]; then
          echo "[DRY RUN] Would create cost center '$CC_NAME'"
          CC_ID="dry-run-cc-id"
        else
          echo ""
          if [[ -n "$FORCE" ]]; then
            echo "Force mode: Creating cost center '$CC_NAME'..."
            vlog "Creating cost center '$CC_NAME'..."
          elif confirm "Create new cost center '$CC_NAME'?"; then
            vlog "Creating cost center '$CC_NAME'..."
          else
            die "Cost center creation cancelled. Cannot proceed without a cost center."
          fi
          
          if CC_ID=$(create_cost_center "$ENTERPRISE" "$CC_NAME"); then
            echo "✓ Created cost center '$CC_NAME' with ID: $CC_ID"
            vlog "Successfully created cost center '$CC_NAME' -> ID $CC_ID"
          else
            die "Failed to create cost center '$CC_NAME'. Check permissions and try again."
          fi
        fi
      else
        echo ""
        echo "Cost center '$CC_NAME' not found in enterprise '$ENTERPRISE'."
        echo "Available options:"
        echo "1. Use an existing cost center name"
        echo "2. Add --create-cost-center flag to create it automatically"
        echo "3. Add --force flag to auto-create and skip confirmations"
        echo "4. Use --cost-center-id with an existing cost center ID"
        die "Cost center not found. See options above."
      fi
    else
      vlog "Resolved cost center '$CC_NAME' -> ID $CC_ID"
    fi
  else
    vlog "Using provided cost center ID: $CC_ID"
  fi

  # Step 2: Resolve team slug/ID from name
  vlog "Resolving team '$TEAM_INPUT'..."
  
  TEAMS_JSON=$(gh api "${COMMON_HEADERS[@]}" \
    "/enterprises/${ENTERPRISE}/teams?per_page=100" \
    --paginate 2>/dev/null || die "Failed to fetch teams. Check enterprise permissions and early access to Enterprise Teams API.")
  
  # Try to find team by exact name or slug match
  TEAM_SLUG=$(echo "$TEAMS_JSON" | jq -r --arg q "$TEAM_INPUT" '
    .[] | select((.slug==$q) or (.name==$q)) | .slug
  ' | head -n1)

  if [[ -z "$TEAM_SLUG" || "$TEAM_SLUG" == "null" ]]; then
    # Fallback: treat input as slug directly and test if it exists
    TEAM_SLUG="$TEAM_INPUT"
    vlog "Team not found by name, trying as slug: $TEAM_SLUG"
    
    # Test if team exists by trying to get it
    if ! gh api "${COMMON_HEADERS[@]}" "/enterprises/${ENTERPRISE}/teams/${TEAM_SLUG}" >/dev/null 2>&1; then
      die "Team '$TEAM_INPUT' not found in enterprise '$ENTERPRISE'. Check the team name or slug."
    fi
  else
    vlog "Resolved team '$TEAM_INPUT' -> slug '$TEAM_SLUG'"
  fi

  # Step 3: Fetch team members
  vlog "Fetching members for team '$TEAM_SLUG'..."
  
  MEMBERS_JSON=$(gh api "${COMMON_HEADERS[@]}" \
    "/enterprises/${ENTERPRISE}/teams/${TEAM_SLUG}/memberships?per_page=100" \
    --paginate 2>/dev/null || die "Failed to fetch team members. Check team slug and permissions.")
  
  # Extract usernames from the member objects
  populate_array_from_command TEAM_USERS "echo '$MEMBERS_JSON' | jq -r '.[].login // empty' | sort -u"
  
  [[ ${#TEAM_USERS[@]} -eq 0 ]] && die "No members found for team '$TEAM_SLUG'."
  vlog "Found ${#TEAM_USERS[@]} team members"

  # Step 4: Get current cost center users to avoid duplicates
  vlog "Fetching current cost center users..."
  
  if [[ -n "$DRY_RUN" && "$CC_ID" == "dry-run-cc-id" ]]; then
    # In dry-run mode with a new cost center, assume no existing users
    vlog "Dry-run mode with new cost center - assuming no existing users"
    CC_USERS=()
  else
    CC_DETAILS_JSON=$(gh api "${COMMON_HEADERS[@]}" \
      "/enterprises/${ENTERPRISE}/settings/billing/cost-centers/${CC_ID}" \
      2>/dev/null || die "Failed to fetch cost center details. Check cost center ID and permissions.")
    
    # Extract current users from the resources array - handle different JSON structures
    populate_array_from_command CC_USERS "echo '$CC_DETAILS_JSON' | jq -r 'if type == \"array\" then .[].resources[]? else .resources[]? end | select(.type==\"User\") | .name // empty' | sort -u"
  fi
  
  # Step 5: Compute users to add (those not already in cost center)
  TO_ADD=()
  if [[ ${#CC_USERS[@]} -gt 0 ]]; then
    CC_SET=$(printf "%s\n" "${CC_USERS[@]}" | sort -u)
    for user in "${TEAM_USERS[@]}"; do
      if ! echo "$CC_SET" | grep -qxF "$user"; then
        TO_ADD+=("$user")
      fi
    done
  else
    TO_ADD=("${TEAM_USERS[@]}")
  fi

  # Step 6: Display summary and confirm
  echo ""
  echo "Summary:"
  echo "  Enterprise: $ENTERPRISE"
  echo "  Team: $TEAM_INPUT ($TEAM_SLUG)"
  if [[ "$CC_ID" == "dry-run-cc-id" ]]; then
    echo "  Cost Center: $CC_NAME (would be created)"
  else
    echo "  Cost Center: $CC_NAME ($CC_ID)"
  fi
  echo "  Team members: ${#TEAM_USERS[@]}"
  echo "  Already in cost center: $((${#TEAM_USERS[@]} - ${#TO_ADD[@]}))"
  echo "  To add: ${#TO_ADD[@]}"
  
  if [[ ${#TO_ADD[@]} -eq 0 ]]; then
    echo ""
    echo "✓ All team members are already in the cost center. Nothing to do."
    exit 0
  fi

  echo ""
  echo "Users to add:"
  printf "  %s\n" "${TO_ADD[@]}"

  if [[ -n "$DRY_RUN" ]]; then
    echo ""
    if [[ "$CC_ID" == "dry-run-cc-id" ]]; then
      echo "[DRY RUN] Would create cost center '$CC_NAME' and add ${#TO_ADD[@]} users to it. No changes made."
    else
      echo "[DRY RUN] Would add ${#TO_ADD[@]} users to cost center. No changes made."
    fi
    exit 0
  fi

  echo ""
  if [[ "$CC_ID" == "dry-run-cc-id" ]]; then
    die "Error: Cost center ID is invalid for actual execution. This should not happen."
  fi
  
  if ! confirm "Proceed to add ${#TO_ADD[@]} users to cost center '$CC_ID'?"; then
    echo "Operation cancelled."
    exit 0
  fi

  # Step 7: Add users to cost center
  log "Adding users to cost center..."
  
  # The API accepts up to 50 resources per request, so we'll batch if needed
  BATCH_SIZE=50
  added=0
  failures=0
  
  for ((i=0; i<${#TO_ADD[@]}; i+=BATCH_SIZE)); do
    # Get batch of users
    batch=("${TO_ADD[@]:i:BATCH_SIZE}")
    batch_size=${#batch[@]}
    
    vlog "Adding batch of $batch_size users: ${batch[*]}"
    
    # Create JSON payload for this batch
    payload=$(printf '%s\n' "${batch[@]}" | jq -R . | jq -s '{users: .}')
    
    if gh api "${COMMON_HEADERS[@]}" \
      --method POST \
      "/enterprises/${ENTERPRISE}/settings/billing/cost-centers/${CC_ID}/resource" \
      --input - <<<"$payload" >/dev/null 2>&1; then
      added=$((added + batch_size))
      vlog "Successfully added batch of $batch_size users"
    else
      failures=$((failures + batch_size))
      echo "Failed to add batch: ${batch[*]}" >&2
    fi
  done

  # Step 8: Report results
  echo ""
  if [[ $added -gt 0 ]]; then
    echo "✓ Successfully added $added users to cost center '$CC_ID'"
  fi
  
  if [[ $failures -gt 0 ]]; then
    echo "✗ Failed to add $failures users" >&2
    exit 2
  fi

  # Step 9: Sync functionality - remove users not in team
  if [[ "$SYNC_MODE" == "true" ]]; then
    echo ""
    echo "=== Synchronizing cost center membership ==="
    
    # Get current cost center users
    vlog "Getting current cost center users..."
    CC_USERS=()
    read_array_from_json CC_USERS "gh api ${COMMON_HEADERS[*]} \"/enterprises/${ENTERPRISE}/settings/billing/cost-centers/${CC_ID}/resource\" | jq -r '.resources[]?.users[]? // empty'"
    
    if [[ ${#CC_USERS[@]} -eq 0 ]]; then
      echo "✓ Cost center has no users to sync"
    else
      echo "Found ${#CC_USERS[@]} users in cost center: ${CC_USERS[*]}"
      
      # Find users to remove (in cost center but not in team)
      TO_REMOVE=()
      for cc_user in "${CC_USERS[@]}"; do
        found=false
        for team_user in "${TEAM_USERS[@]}"; do
          if [[ "$cc_user" == "$team_user" ]]; then
            found=true
            break
          fi
        done
        if [[ "$found" == "false" ]]; then
          TO_REMOVE+=("$cc_user")
        fi
      done
      
      if [[ ${#TO_REMOVE[@]} -eq 0 ]]; then
        echo "✓ No users need to be removed - cost center is already synchronized"
      else
        echo "Found ${#TO_REMOVE[@]} users to remove: ${TO_REMOVE[*]}"
        
        if [[ "$FORCE_MODE" != "true" ]]; then
          echo ""
          echo "These users will be REMOVED from cost center '$CC_NAME':"
          printf "  - %s\n" "${TO_REMOVE[@]}"
          echo ""
          if ! confirm "Continue with removal?"; then
            echo "Removal cancelled."
            exit 0
          fi
        fi
        
        if ! remove_users_from_cost_center "$ENTERPRISE" "$CC_ID" "${TO_REMOVE[@]}"; then
          echo "Failed to remove users from cost center" >&2
          exit 1
        fi
      fi
    fi
  fi
  
  echo ""
  echo "Operation completed successfully!"
  exit 0
}

main() {
  sub="${1:-}"
  if [[ $# -gt 0 ]]; then shift; fi
  
  case "$sub" in
    add-team) cmd_add_team "$@";;
    -h|--help|help|"") usage; exit 0;;
    *) die "Unknown subcommand: $sub. Use 'gh cost-center --help' for usage.";;
  esac
}

main "$@"
